---
title: "Event sequences in Fragile X-associated tremor/ataxia syndrome"
knitr:
  opts_chunk: 
    collapse: true
    comment: "#>" 
    R.options:  
      dev: svg

project:
  execute-dir: project
---

```{=html}
<style>
.quarto-figure-center > figure {
text-align: center;
}
</style>
```

# Introduction

Here, we apply the Ordinal **Su**btype and **St**age **In**ference ("SuStaIn") algorithm [@young2021ordinal] to find event sequences for FXTAS patients.

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  # fig.width = 7, 
  # fig.height = 10,
  include = TRUE
)
```

```{r setup}
#| message: false
# devtools::load_all()
library(fxtas)
reticulate::use_condaenv("fxtas39",required = TRUE)
library(tidyverse)
library(reticulate)
library(pander)
library(table1)
```

```{r}
# reticulate::use_condaenv(condaenv = "fxtas")
```

```{r}
#| label: "set run parameters"
#| 
fit_models = TRUE
fit_models = FALSE
run_CV =  TRUE
# run_CV = FALSE

N_startpoints = 10L
N_S_max = 8L
N_S_max_stratified = 1L
N_CV_folds = 10L
N_iterations_MCMC = 1e5L
dataset_name = 'sample_data'
root_dir = here::here()
setwd(root_dir)
output_folder = 
  "output/output.fixed_CV/" |> 
  fs::dir_create()
```

# Methods

## Data


```{r}
#| label: fig-hist-CGG-gp34-v1
#| fig-cap: "Bar-plot of CGG repeats among GP/GP4 participants"
#| warning: false

visit1 |> graph_CGG_repeats(rows = vars(Gender))

```

```{r}
n_missing_CGG = visit1$CGG |> is.na() |> sum()
n_above_200 = sum(visit1$CGG >= 200, na.rm = TRUE)
gp34_v1_usable = visit1 |> filter(CGG < 200)
gp34_v1_cases = gp34_v1_usable |> filter(CGG >= 55)
# note: there are 231 records in `visit1` with CGG >= 55, but 4 have CGG >= 200
# previously `nrow(gp34_v1_cases)` was 221, which was based on incorrectly filtering on a version of CGG that hadn't been backfilled.

gp34_v1_controls =  gp34_v1_usable |> filter(CGG < 55)
```

The data come from the GP and GP4 studies. In the primary analyses, we analyzed one visit record per participant, using the earliest visit available across the two studies with age at visit $\ge 40$ years, resulting in `r nrow(visit1)` observations in total. However, `r n_missing_CGG` individuals did not have CGG values available, and `r n_above_200` had full fragile X syndrome mutation (≥200 CGG repeats; @fig-hist-CGG-gp34-v1), so only `r nrow(gp34_v1_usable)` individuals 
(`r nrow(gp34_v1_cases)` cases and 
`r nrow(gp34_v1_controls)` controls) were included in the event sequence analysis.

```{r}

biomarker_groups = compile_biomarker_groups_table()

biomarker_varnames = 
  biomarker_groups |> 
  pull("biomarker")

biomarker_levels = 
  gp34_v1_usable |> 
  select(all_of(biomarker_varnames)) |> 
  lapply(F = levels)

df = gp34_v1_usable |>
  mutate(
    across(
      all_of(biomarker_varnames), 
      ~ as.integer(.x) - 1),
    Diagnosis = as.integer(`FX*` == "CGG >= 55"))

biomarker_events_table =
  construct_biomarker_events_table(
    biomarker_levels,
    biomarker_groups)

nlevs = 
  biomarker_levels |> sapply(length)

```

We analyzed `r length(biomarker_levels)` biomarkers (@tbl-biomarker-list) with a total of `r nrow(biomarker_events_table)` non-baseline levels; each level above baseline constitutes an outcome event in the disease progression modelling analysis (@sec-Statistical-analysis).

```{r}
#| tbl-cap: "Biomarkers used in analysis"
#| label: "tbl-biomarker-list"

table_out =
  biomarker_events_table |> 
  select(category = biomarker_group, biomarker, levels) |> 
  slice_head(by = biomarker)

table_out |> pander()

```

The trailing asterisk (*) indicates a numeric variable that has been categorized for use with Ordinal SusTaIn.

{{< include exploration.qmd >}}

{{< include demos-by-sex.qmd >}}

## Statistical analysis {#sec-Statistical-analysis}

We applied  the Ordinal **Su**btype and **St**age **In**ference ("SuStaIn") algorithm [@young2018uncovering; @young2021ordinal] to our dataset to find event sequences and subgroupings for FXTAS patients. This algorithm combines disease progression modelling [@fonteijn2012event] and unsupervised clustering to model event onset sequences using a cross-sectional sample of a patient population. The algorithm simultaneously clusters individuals into subgroups and characterizes the trajectory that best defines each subgroup, thus capturing heterogeneity in both disease subtype and disease stage.

Ordinal SuStaIn uses Markov Chain Monte Carlo (MCMC) sampling to estimate the Bayesian posterior probability of each possible event sequence for each subgroup given the training dataset, assuming a uniform prior distribution over the set of all possible patterns. 

We first fit the model using the first visit after age 40 for each participant in GP+GP4, assuming one shared event sequence (no latent subgroups; see @fig-first-only-1).

### Stratified analyses

We also fit the model stratified by sex (again with no latent subgroups; one event sequence per per sex; see @fig-first-only-2 and @fig-first-only-3).

We also fit the model stratified by CGG repeats (<100 vs $\ge$ 100), also with no latent subgroups (see @fig-pvd-by-cgg).

### Latent subgroups

We also fit the model on the full dataset (not stratified by sex or CGG) for 2-6 latent subgroups, each with their own ordering (@fig-pvd4). We determined the optimal number of latent subgroups for this dataset using the CVIC criterion (@sec-cvic). 

### Adding Trax data

```{r}
n_trax_added_cases = 
  males_gp34_trax_v1 |> 
  filter(
    Studies == "TRAX",
    CGG |> between(55, 200)) |> 
  nrow()

n_trax_added_controls = 
  males_gp34_trax_v1 |> 
  filter(
    Studies == "TRAX",
    CGG < 55) |> 
  nrow()
```


We also considered adding Trax data for the stratified analysis of males (@fig-trax); doing so added `r n_trax_added_cases` additional cases and `r n_trax_added_controls` additional controls (@tbl-trax-counts).

```{r}
#| tbl-cap: "Study participation among males, by CGG status"
#| label: tbl-trax-counts

males_gp34_trax_v1 |> 
  dplyr::filter(CGG < 200) |> 
  arrange(GP3, GP4, TRAX) |> 
  mutate(Studies = factor(Studies)) |> 
  table1(na.is.category = FALSE, ~ Studies |`FX*`, data = _)
```


### Longitudinal subsets

Next, we fit the Ordinal SuStaIn model on nine subsets of the longitudinal GP+GP4 data:

- Males only (@fig-males):
* first visits only (@fig-males-1)
* all visits (@fig-males-2)
* multivisit patients only (@fig-males-3)

- Females only (@fig-females):
* first visits only (@fig-females-1)
* all visits (@fig-females-2)
* multivisit patients only (@fig-females-3)

- Unstratified (@fig-both-genders):
* first visits only (@fig-both-genders-1)
* all visits (@fig-both-genders-2)
* multivisit patients only (@fig-both-genders-3)

We also rearranged these results by subset type:

- first visits only (@fig-first-only)
- all visits (@fig-all-visits)
- multivisit patients only (@fig-mv-only)


### Visualizing modeling results

We visualized the results of Ordinal SuStaIn analysis using "positional variance diagrams" (PVDs), which are heatmaps with biomarker events on the y-axis and sequence positions on the x-axis. 

The PVD's color scale indicates the Bayesian posterior probability that a particular biomarker event (y-axis) appears at a particular position along the progression sequence (x-axis). Red indicates a more probable sequence position, and gray indicates a less probable position.

```{r}

ModelScores = DataScores = 
  df |> 
  select(all_of(biomarker_varnames)) |> 
  # lapply(F = levels)
  compute_score_levels()


control_data = 
  df |> 
  filter(`FX*` == "CGG < 55") |> 
  select(all_of(biomarker_varnames))

patient_data = 
  df |> 
  # na.omit() |>
  filter(`FX*` == "CGG >= 55")

prob_correct = 
  control_data |> 
  compute_prob_correct(
    max_prob = .95,
    biomarkers = biomarker_varnames,
    DataScores = DataScores)

prob_score0 = compute_prob_scores(
  dataset = patient_data,
  biomarker_varnames,
  ModelScores = ModelScores,
  DataScores = DataScores,
  prob_correct = prob_correct
)

prob_nl = prob_score0[,,1]
prob_score = prob_score0[,,-1, drop = FALSE]

```

```{r "score_vals"}

# sapply(X = biomarker_varnames, F = function(x) 1:nlevs[x])

score_vals = matrix(
  ModelScores[-1] |> as.numeric(),
  byrow = TRUE,
  nrow = length(biomarker_varnames),
  ncol = length(ModelScores) - 1,
  dimnames = list(biomarker_varnames, ModelScores[-1]))

for (i in biomarker_varnames)
{
  score_vals[i,score_vals[i,] > nlevs[i]-1] = 0
}

save.image(file = fs::path(output_folder, "data.RData"))

```

```{r "run OSA from R"}
#| message: false
#| label: model-all-data
#| include: false
#| eval: !expr fit_models

sustain_output = run_OSA(
  prob_score = prob_score0,
  score_vals = score_vals,
  SuStaInLabels = biomarker_varnames,
  N_startpoints = N_startpoints,
  N_S_max = N_S_max, 
  N_iterations_MCMC = N_iterations_MCMC, 
  output_folder = output_folder, 
  dataset_name = dataset_name, 
  use_parallel_startpoints = FALSE,
  seed = 1,
  plot = FALSE,
  patient_data = patient_data,
  CV_fold_nums = c(1:5, 7:10),
  N_CV_folds = N_CV_folds)



```

```{r}
#| message: false
#| label: model-males
#| include: false
#| eval: !expr fit_models

sustain_output_males = run_OSA(
  prob_score = prob_score0[patient_data$Gender %in% "Male",,],
  score_vals = score_vals,
  SuStaInLabels = biomarker_varnames,
  N_startpoints = N_startpoints,
  N_S_max = N_S_max_stratified, 
  N_iterations_MCMC = N_iterations_MCMC, 
  output_folder = output_folder, 
  dataset_name = "males", 
  use_parallel_startpoints = FALSE,
  seed = 1,
  plot = FALSE)

```


```{r}
#| message: false
#| label: model-females
#| include: false
#| eval: !expr fit_models
sustain_output_females = run_OSA(
  prob_score = prob_score0[patient_data$Gender %in% "Female",,],
  score_vals = score_vals,
  SuStaInLabels = biomarker_varnames,
  N_startpoints = N_startpoints,
  N_S_max = N_S_max_stratified, 
  N_iterations_MCMC = N_iterations_MCMC, 
  output_folder = output_folder, 
  dataset_name = "females", 
  use_parallel_startpoints = FALSE,
  seed = 1,
  plot = FALSE)

```


```{r}
#| message: false
#| label: "cgg_over_100"
#| include: false
#| eval: !expr fit_models
sustain_output_cgg100plus = run_OSA(
  prob_score = prob_score0[
    patient_data$`CGG` >= 100,,],
  score_vals = score_vals,
  SuStaInLabels = biomarker_varnames,
  N_startpoints = N_startpoints,
  N_S_max = N_S_max_stratified, 
  N_iterations_MCMC = N_iterations_MCMC, 
  output_folder = output_folder, 
  dataset_name = "over100", 
  use_parallel_startpoints = FALSE,
  seed = 1,
  plot = FALSE)

```

```{r}
#| message: false
#| label: "cgg_under_100"
#| include: false
#| eval: !expr fit_models
sustain_output_cgg100minus = run_OSA(
  prob_score = prob_score0[
    patient_data$`CGG` < 100,,],
  score_vals = score_vals,
  SuStaInLabels = biomarker_varnames,
  N_startpoints = N_startpoints,
  N_S_max = N_S_max_stratified, 
  N_iterations_MCMC = N_iterations_MCMC, 
  output_folder = output_folder, 
  dataset_name = "under100", 
  use_parallel_startpoints = FALSE,
  seed = 1,
  plot = FALSE)

```


# Results

```{r}
#| label: extract-figs

results_v1 = extract_results_from_pickle(
  n_s = 1:2,
  rda_filename = "data.RData",
  dataset_name = "sample_data",
  output_folder = "output/output.fixed_CV")

results_females_first = extract_results_from_pickle(
  n_s = 1,
  rda_filename = "data.RData",
  dataset_name = "females",
  output_folder = "output/output.fixed_CV")

fig_females_first = extract_figs_from_pickle(
  n_s = 1,
  rda_filename = "data.RData",
  dataset_name = "females",
  output_folder = "output/output.fixed_CV")

fig_females_all = extract_figs_from_pickle(
  n_s = 1,
  rda_filename = "gp34_longitudinal.RData",
  dataset_name = "females",
  output_folder = "output/gp34_longitudinal")

fig_females_mv_only = extract_figs_from_pickle(
  n_s = 1,
  rda_filename = "gp34_multivisit_only.RData",
  dataset_name = "females",
  output_folder = "output/gp34_multivisit_only")


fig_males_first = extract_figs_from_pickle(
  n_s = 1,
  rda_filename = "data.RData",
  dataset_name = "males",
  output_folder = "output/output.fixed_CV")

fig_males_all = extract_figs_from_pickle(
  n_s = 1,
  rda_filename = "gp34_longitudinal.RData",
  dataset_name = "males",
  output_folder = "output/gp34_longitudinal")

fig_males_mv_only = extract_figs_from_pickle(
  n_s = 1,
  rda_filename = "gp34_multivisit_only.RData",
  dataset_name = "males",
  output_folder = "output/gp34_multivisit_only")

fig_both_first = extract_figs_from_pickle(
  n_s = 1,
  rda_filename = "data.RData",
  dataset_name = "sample_data",
  output_folder = "output/output.fixed_CV")

fig_both_all = extract_figs_from_pickle(
  n_s = 1,
  rda_filename = "gp34_longitudinal.RData",
  dataset_name = "gp34_longitudinal",
  output_folder = "output/gp34_longitudinal")

fig_both_mv_only = extract_figs_from_pickle(
  n_s = 1,
  rda_filename = "gp34_multivisit_only.RData",
  dataset_name = "gp34_multivisit_only",
  output_folder = "output/gp34_multivisit_only")

fig_male_trax_gp34 = extract_figs_from_pickle(
  n_s = 1,
  rda_filename = "data.Rdata",
  dataset_name = "sample_data",
  output_folder = "output/trax_gp34_males_v1")

fig_trax_only = extract_figs_from_pickle(
  n_s = 1,
  rda_filename = "data.Rdata", 
  dataset_name = "trax_visit1",
  output_folder = "outputOLD/trax_visit1")

fig_under100 = extract_figs_from_pickle(
  n_s = 1,
  dataset_name = "under100",
  output_folder = output_folder)

fig_over100 = extract_figs_from_pickle(
  n_s = 1,
  dataset_name = "over100",
  output_folder = output_folder)

fig_under100_males = extract_figs_from_pickle(
  n_s = 1,
  dataset_name = "under100_Male",
  output_folder = output_folder)

fig_over100_males = extract_figs_from_pickle(
  n_s = 1,
  dataset_name = "over100_Male",
  output_folder = output_folder)


fig_under100_females = extract_figs_from_pickle(
  n_s = 1,
  dataset_name = "under100_Female",
  output_folder = output_folder)

fig_over100_females = extract_figs_from_pickle(
  n_s = 1,
  dataset_name = "over100_Female",
  output_folder = output_folder)

```


## All patients, first visits only

@fig-first-only-1 shows the event sequence model, estimated using the first visits per participant from the combined GP and GP4 data and assuming that all individuals share the same event sequence; in other words, assuming one subgroup.

@fig-first-only-2 and @fig-first-only-3 show estimated event sequences stratified by sex, assuming one  subgroup per sex. It appears that males experience increasing ataxia severity earlier in the event sequence than females, while females experience MRI events and SCL psychological symptoms earlier in the event sequence than males.^[There are probably other patterns worth noting here; clinical folks, let us know what you notice!]


```{r}
#| label: "fig-first-only"
#| column: screen
#| fig-height: 15
#| fig-align: center
#| fig-cap: "Estimated event sequence models - overall and stratified by sex, first visits only"
#| fig-cap-location: top
#| layout-ncol: 3
#| fig-subcap:
#|   - "Unstratified" 
#|   - "Males"
#|   - "Females"


fig_both_first |> print()
fig_males_first |> print()
fig_females_first |> print()

```

## Stratified by CGG repeats

@fig-pvd-by-cgg shows the estimated event sequence model, this time comparing the unstratified results with stratification by CGG repeats (<100 vs 100+; assuming no latent subgroups within strata). Here, we find that patients with CGG <100 experienced SCL90 events earlier in the sequence than patients with CGG $\ge$ 100.

```{r}
#| label: "fig-pvd-by-cgg"
#| column: screen
#| fig-height: 15
#| fig-align: center
#| fig-cap: "Estimated event sequences, stratified by CGG repeats (<100 vs 100+); first visits only"
#| fig-cap-location: top
#| layout-ncol: 3
#| fig-subcap:
#|   - "Unstratified"
#|   - "CGG < 100"
#|   - "CGG 100+"

fig_both_first |> print() 
fig_under100 |> print()
fig_over100 |> print()

```

## Stratified by CGG and Sex

```{r}
#| label: "fig-pvd-by-cgg-male"
#| column: screen
#| fig-height: 15
#| fig-align: center
#| fig-cap: "Estimated event sequences, stratified by CGG repeats (<100 vs 100+); first visits only, males only"
#| fig-cap-location: top
#| layout-ncol: 3
#| fig-subcap:
#|   - "Males"
#|   - "Males, CGG < 100"
#|   - "Males, CGG ≥ 100"

fig_males_first |> print() 
fig_under100_males |> print()
fig_over100_males |> print()

```

```{r}
#| label: "fig-pvd-by-cgg-female"
#| column: screen
#| fig-height: 15
#| fig-align: center
#| fig-cap: "Estimated event sequences, stratified by CGG repeats (<100 vs 100+); first visits only, females only"
#| fig-cap-location: top
#| layout-ncol: 3
#| fig-subcap:
#|   - "Females"
#|   - "Females, CGG < 100"
#|   - "Females, CGG ≥ 100"

fig_females_first |> print() 
fig_under100_females |> print()
fig_over100_females |> print()

```

## Latent subgroups {#sec-latent-subgroups}

```{r}
n_s = 4
```

Based on the CVIC criterion (@sec-cvic), it appears that `r n_s` subgroups is the optimal number for the full, unstratified GP+GP4 dataset.
@fig-pvd4 shows positional variance diagrams (PVDs) for each of the subgroup clusters detected under this assumption, and @tbl-sg_demos shows the demographics of the patients clustered in each subgroup; patients in the "Type 0" category were too early in the disease process to be classified into a subgroup.

```{r}

figs = extract_figs_from_pickle(
  n_s = n_s,
  dataset_name = dataset_name,
  output_folder = output_folder)
```

```{r}
#| label: "fig-pvd4"
#| layout-ncol: 4
#| fig-height: 15
#| fig-align: center
#| fig-cap: "positional variance diagrams for 4 subgroups"
#| fig-cap-location: top
#| column: screen
#| fig-subcap:
#|   - "Subgroup 1"
#|   - "Subgroup 2"
#|   - "Subgroup 3"
#|   - "Subgroup 4"
library(ggplot2)

figs |> 
  print_PVDs()

```

```{r}
#| tbl-cap: !expr glue::glue("Subgroup demographics ({n_s} subgroups)")
#| label: tbl-sg_demos
#| results: asis

results_cv_max = extract_results_from_pickle(
  n_s = n_s,
  dataset_name = dataset_name,
  output_folder = output_folder)

table_subtype_by_demographics(
  patient_data,
  subtype_and_stage_table = results_cv_max$subtype_and_stage_table
)

```

```{r}
#| label: fig-stage-by-age
#| fig-cap: "ML stage by age and latent subtype"
#| include: false

stages = 
  results_cv_max$subtype_and_stage_table |> 
  mutate(
    age = patient_data$`Age at first visit`
  )

library(ggplot2)
stages |>
  graph_stage_by_age()


```


## Adding Trax data

```{r}
#| label: "fig-trax"
#| column: screen
#| fig-height: 15
#| fig-align: center
#| fig-cap: "Estimated event sequence models - males only: GP+GP4, Trax, and GP+GP4+Trax"
#| fig-cap-location: top
#| layout-ncol: 3
#| fig-subcap:
#|   - "GP+GP4 males only"
#|   - "Trax+GP+GP4, males only" 
#|   - "Trax only"

fig_males_first |> print()
fig_male_trax_gp34 |> print()
fig_trax_only |>  print()

```

## Longitudinal data

### Males

@fig-males shows estimated event sequences for males, depending on which subset of the data we use to fit the model.

```{r}
#| label: "fig-males"
#| column: screen
#| fig-height: 15
#| fig-align: center
#| fig-cap: "Estimated event sequences for males, by data subset"
#| fig-cap-location: top
#| layout-ncol: 3
#| fig-subcap:
#|   - "First visits only"
#|   - "All visits" 
#|   - "Multivisit patients only"

fig_males_first |> print()

fig_males_all |> print()

fig_males_mv_only |> print()

```

### Females

```{r}
#| label: "fig-females"
#| fig-cap: "Estimated event sequences for females, by data subset"
#| column: screen
#| fig-height: 15
#| fig-align: center
#| fig-cap-location: top
#| layout-ncol: 3
#| fig-subcap:
#|   - "First visits only"
#|   - "All visits" 
#|   - "Multivisit patients only"

fig_females_first |> print()

fig_females_all |> print()

fig_females_mv_only |> print()

```


### Unstratified, by data subset

```{r}
#| label: "fig-both-genders"
#| column: screen
#| fig-height: 15
#| fig-align: center
#| fig-cap: "Estimated event sequences, unstratified, by data subset"
#| fig-cap-location: top
#| layout-ncol: 3
#| fig-subcap:
#|   - "First visits only"
#|   - "All visits" 
#|   - "Multivisit patients only"

fig_both_first |> print()
fig_both_all |> print()
fig_both_mv_only |> print()

```



### All patients, all visits

@fig-all-visits shows the event sequences that we estimated from each data subset. Note that clinical events which never occur in a dataset cannot be placed into the event sequence, so the set of modeled events varies by data subset.

We note that Parkinsonian features mostly appear after FXTAS stage 4 for females, whereas they occur before stage 4 for males.

Similarly, clinically-elevated SCL90 values appear before FXTAS stage 1 for females, whereas they occur after stage 3 for males.


```{r}
#| label: "fig-all-visits"
#| column: screen
#| fig-height: 15
#| fig-align: center
#| fig-cap: "Estimated event sequences - all visits"
#| fig-cap-location: top
#| layout-ncol: 3
#| fig-subcap:
#|   - "Unstratified"
#|   - "Males only" 
#|   - "Females only"

fig_both_all |> print()
fig_males_all |> print()
fig_females_all |> print()

```

```{r}
#| label: fig-stage-by-age-longitudinal
#| fig-cap: "ML stage by age, longitudinal data"
#| include: false
stages = 
  results_cv_max$subtype_and_stage_table |> 
  mutate(
    age = patient_data$`Age at first visit`
  )

library(ggplot2)
stages |>
  graph_stage_by_age()


```

### Multivisit patients only, all visits

@fig-mv-only shows the event sequences that we estimated using only the data from patients with more than one visit.

```{r}
#| label: "fig-mv-only"
#| column: screen
#| fig-height: 15
#| fig-align: center
#| fig-cap: "Estimated event sequences - multivisit patients only"
#| fig-cap-location: top
#| layout-ncol: 3
#| fig-subcap:
#|   - "Unstratified"
#|   - "Males only" 
#|   - "Females only"

fig_both_mv_only |> print()
fig_males_mv_only |> print()
fig_females_mv_only |> print()

```


# Discussion

[to be added]

# References {.unnumbered}

::: {#refs}
:::

# Appendix {.appendix}

{{< include general-data-notes.qmd >}}

## Detecting latent subgroups {#sec-subgroups .appendix}

In order to the Ordinal SuStaIn algorithm, we must specify how many latent subgroups to model. There are several metrics for determining the optimal number of subgroups for a given data set.

### Likelihood {.appendix}

The simplest option is to compare the likelihood of the data for the fitted model while varying the number of subgroups used to fit the model. @fig-mcmc-loglik shows the distribution of log-likelihoods from the MCMC samples for the full dataset (not stratified by sex or CGG repeats). Adding up to 6 clusters substantially improves the log-likelihood.

```{r}
#| fig-height: 4
#| label: fig-mcmc-loglik
#| fig-cap: log-likelihoods of MCMC samples, by number of subtypes
#| eval: !expr fit_models

results_v1 = extract_results_from_pickle(
  n_s = 1,
  rda_filename = "data.RData",
  dataset_name = "sample_data",
  output_folder = "output/output.fixed_CV")

sustain_output$samples_likelihood |>
  graph_likelihoods_v2(alpha = 0.5) |>
  suppressWarnings()

```

### Cross-Validation Information Criterion {#sec-cvic .appendix}

Since models with fewer subtypes are limited special cases of models with more subtypes (i.e., "nested models"), the likelihood of the training data is guaranteed to improve as we increase the number of subtypes. However, using too many subtypes means there is less data available for each subtype, possibly leading to a model that does not generalize well to new data (i.e., a model that is "overfit" to the training data).

To avoid overfitting, @young2018uncovering recommends choosing the optimal number using the the Cross-Validation Information Criterion (CVIC):

#### Mathematical details of cross-validation criteria {#sec-cvic-math .appendix}

Let:

* $n$ be the number of observations in the dataset
* $Y_i$ be the observed biomarker values for the $i^{th}$ participant
* $\mathcal C$ be the number of latent subtypes assumed, with corresponding index $c$.
* $C_i$ be the latent subgroup membership of observation $i$
* $\mathcal S$ be the set of possible event sequences, indexed by $\mathcal s$
* $S_c \in \mathcal S$ be the sequence for subgroup $c$
* $K$ be the number of cross-validation folds, with index $k$; typically, $K = 10$.
* $n_k$ be the number of held-out observations in cross-validation fold $K$; $n_k \approx n/K$
* $\hat{P}_{(-k)}(C = c)$ be the prior probability that an observation belongs to subgroup $c$, estimated using all observations except those in fold $k$.

Then:

$$
CVIC_{\mathcal C} = 
-2 * 
\sum_{k=1}^K 
\sum_{i=1}^{n_k} 
\log
\left\{
\sum_{c=1}^\mathcal C 
\sum_{s\in \mathcal S}
\hat P(Y_i|C_i = c, S_c=s)
\hat{P}_{(-k)}(C_i = c, S_c = s)
\right\}
$$

#### CVIC for the full GP+GP4 dataset {.appendix}

We performed `r N_CV_folds`-fold cross-validation on the unstratified GP+GP4 data, and calculated the CVIC for 1-6 latent subgroups.

```{r}
#| fig-cap: "Cross-validation information criterion"
#| label: fig-cvic
#| eval: !expr fit_models

library(ggplot2)

temp = sustain_output |> attr("CV")
temp$CVIC |> plot_CVIC()

```

It appears that the model nearly reaches peak CVIC by 4 subgroups.

## Out-of-fold log-likelihood distribution {.appendix}

We also evaluated the consistency of our cross-validation procedure by looking at the distribution of test-set log-likelihood across folds (@fig-boxplot-loglik-cv); following @young2018uncovering, we calculated out-of-sample log-likelihood as:

$$
\ell_{\mathcal C, k} = 
\sum_{i = 1}^{n_k}
\sum_{c=1}^\mathcal C 
\sum_{s\in \mathcal S}
\log
\left\{
\hat P(Y_i|C_i = c, S_c=s)
\right\}
\hat{P}_{(-k)}(C_i = c, S_c = s)
$$


```{r}
#| fig-cap: "Test set log-likelihood across folds"
#| label: fig-boxplot-loglik-cv
#| eval: !expr fit_models
temp$loglike_matrix |> 
  plot_cv_loglik()

```

